<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Keuangan</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0u/z8hfdzLp2s/w/s2lA2K3n2G/e5lQ5/j8P/0G5f02fW6gN0I/J9QzTzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#1a237e',
            'secondary-blue': '#283593',
            'accent-green': '#388e3c',
            'accent-red': '#d32f2f',
            'dark-gray': '#424242',
            'light-gray': '#f5f5f5',
            'card-bg': '#ffffff',
            'border-light': '#e0e0e0',
          },
        }
      }
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #e0e0e0;
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: #757575;
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #545454;
    }
    @keyframes slide-in-fade {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-in-fade {
      animation: slide-in-fade 0.4s ease-out forwards;
    }
    .transition-all { transition: all 0.3s ease-in-out; }
    .scale-95 { transform: scale(0.95); }
    .scale-100 { transform: scale(1); }
    .opacity-0 { opacity: 0; }
    .opacity-100 { opacity: 1; }
    .chart-container {
      position: relative;
      height: 350px;
      width: 100%;
      padding-bottom: 25px;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
  </style>
</head>
<body class="bg-light-gray min-h-screen text-dark-gray p-6 sm:p-8">
  <div class="max-w-7xl mx-auto">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-primary-blue flex items-center gap-3">
        <i class="fas fa-chart-pie text-secondary-blue"></i> Dashboard Keuangan
      </h1>
      <div class="flex flex-wrap gap-3 justify-center sm:justify-end">
        <select id="bulan" class="border border-border-light px-4 py-2 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition-all">
          <option value="01">Januari</option><option value="02">Februari</option>
          <option value="03">Maret</option><option value="04">April</option>
          <option value="05">Mei</option><option value="06">Juni</option>
          <option value="07">Juli</option><option value="08">Agustus</option>
          <option value="09">September</option><option value="10">Oktober</option>
          <option value="11">November</option><option value="12">Desember</option>
        </select>
        <select id="tahun" class="border border-border-light px-4 py-2 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition-all"></select>
        <button id="downloadLaporanBulanan" class="bg-secondary-blue hover:bg-primary-blue text-white px-5 py-2 rounded-lg shadow-md transition-all focus:outline-none focus:ring-2 focus:ring-secondary-blue focus:ring-offset-2 flex items-center gap-2 text-sm sm:text-base">
          <i class="fas fa-file-pdf"></i> Unduh Laporan
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-card-bg shadow-lg rounded-2xl p-6 text-center border-t-4 border-primary-blue transition-all card-hover">
        <h2 class="text-xl font-semibold text-dark-gray mb-3 flex items-center justify-center gap-2">
          <i class="fas fa-wallet text-accent-green"></i> Total Kekayaan
        </h2>
        <p class="text-3xl sm:text-4xl font-bold text-accent-green flex items-center justify-center gap-2">
          <span id="displayTotalKekayaan">Rp 0</span>
          <span class="toggle-visibility-btn text-primary-blue cursor-pointer text-2xl" data-target="all-nominal">&#128065;</span> 
        </p>
      </div>
      <div id="rekeningList" class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
    </div>

    <div class="bg-card-bg shadow-lg rounded-2xl p-6 mb-8 border-t-4 border-primary-blue transition-all card-hover">
      <div id="chartContainer" class="chart-container">
        <h2 class="text-xl font-semibold text-dark-gray mb-3 text-center flex items-center justify-center gap-2">
          <i class="fas fa-chart-line text-primary-blue"></i> Perkembangan Saldo Tahunan
        </h2>
        <canvas id="balanceChart"></canvas>
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div class="bg-card-bg shadow-lg rounded-xl p-6 border-t-4 border-primary-blue transition-all card-hover">
        <div class="flex justify-between items-center mb-5">
          <h2 class="text-xl font-semibold text-dark-gray flex items-center gap-2">
            <i class="fas fa-sliders-h text-primary-blue"></i> Custom Kategori
          </h2>
          <button id="aturKategoriBtn" class="bg-primary-blue hover:bg-secondary-blue text-white px-4 py-2 rounded-lg shadow-md transition-all focus:outline-none focus:ring-2 focus:ring-primary-blue focus:ring-offset-2 flex items-center gap-2 text-sm">
            <i class="fas fa-cog"></i> Atur Kategori
          </button>
        </div>
        <div id="ringkasanKategoriKustom" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
      </div>
      <div class="bg-card-bg shadow-lg rounded-xl p-6 border-t-4 border-accent-green transition-all card-hover">
        <div class="flex justify-between items-center mb-5">
          <h2 class="text-xl font-semibold text-dark-gray flex items-center gap-2">
            <i class="fas fa-money-bill-wave text-accent-green"></i> Anggaran Bulanan
          </h2>
          <button id="aturAnggaranBtn" class="bg-accent-green hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow-md transition-all focus:outline-none focus:ring-2 focus:ring-accent-green focus:ring-offset-2 flex items-center gap-2 text-sm">
            <i class="fas fa-plus-circle"></i> Atur Anggaran
          </button>
        </div>
        <div id="anggaranSummary" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <p class="text-gray-500 text-center col-span-full">Belum ada anggaran yang diatur untuk bulan ini.</p>
        </div>
      </div>
    </div>

    <div class="bg-card-bg shadow-lg rounded-xl p-6 border-t-4 border-primary-blue">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-5 gap-4">
        <h2 class="text-xl font-semibold text-dark-gray flex items-center gap-2">
          <i class="fas fa-receipt text-gray-600"></i> Transaksi Terbaru
        </h2>
        <div class="flex items-center gap-2 flex-wrap">
          <label for="jumlahTransaksi" class="text-dark-gray text-sm">Tampilkan:</label>
          <select id="jumlahTransaksi" class="border border-gray-300 px-3 py-1 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition-all text-sm">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 mb-5 justify-start">
        <button id="addTransactionBtn" class="bg-primary-blue hover:bg-secondary-blue text-white px-4 py-2 rounded-lg shadow-md transition-all text-sm flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:ring-offset-2">
          <i class="fas fa-plus"></i> Tambah Transaksi
        </button>
        <button id="downloadExcel" class="bg-accent-green hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow-md transition-all text-sm flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-accent-green focus:ring-offset-2">
          <i class="fas fa-file-excel"></i> Excel
        </button>
        <button id="downloadPDF" class="bg-secondary-blue hover:bg-primary-blue text-white px-4 py-2 rounded-lg shadow-md transition-all text-sm flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-secondary-blue focus:ring-offset-2">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
        <button id="exportBackup" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow-md transition-all text-sm flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-offset-2">
          <i class="fas fa-download"></i> Export
        </button>
        <label for="importBackup" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-md cursor-pointer transition-all text-sm flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
          <i class="fas fa-upload"></i> Import
          <input type="file" id="importBackup" class="hidden" accept=".json">
        </label>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <input type="text" id="searchNama" placeholder="Cari nama akun..." class="border border-gray-300 px-4 py-2 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition-all text-sm">
        <select id="filterKategori" class="border border-gray-300 px-4 py-2 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition-all text-sm">
          <option value="">Semua Kategori</option>
        </select>
        <input type="date" id="startDate" class="border border-gray-300 px-4 py-2 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition-all text-sm">
        <input type="date" id="endDate" class="border border-gray-300 px-4 py-2 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue transition-all text-sm">
      </div>

      <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
        <table class="min-w-full text-sm bg-white" id="tabelTransaksi">
          <thead class="bg-primary-blue text-white border-b border-primary-blue">
            <tr>
              <th class="text-left p-3 font-semibold">Tanggal</th>
              <th class="text-left p-3 font-semibold">Rekening</th>
              <th class="text-left p-3 font-semibold">Akun</th>
              <th class="text-left p-3 font-semibold">Kategori</th>
              <th class="text-right p-3 font-semibold">Nominal</th>
              <th class="text-left p-3 font-semibold">Jenis</th>
            </tr>
          </thead>
          <tbody id="transaksiTerakhir" class="divide-y divide-gray-100"></tbody>
        </table>
        <p id="noTransactionsMessage" class="p-4 text-center text-gray-500 hidden">Tidak ada transaksi yang ditemukan.</p>
      </div>

      <div class="flex justify-end mt-7">
        <button id="resetData" class="bg-accent-red hover:bg-red-700 text-white px-5 py-2 rounded-lg shadow-md transition-all flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-accent-red focus:ring-offset-2 text-sm">
          <i class="fas fa-undo-alt"></i> Reset Data
        </button>
      </div>
    </div>
  </div>

  <div id="toastContainer" class="fixed bottom-6 right-6 z-50 space-y-3"></div>

  <div id="modalAturKategori" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-all">
    <div class="bg-card-bg p-8 rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-all">
      <h3 class="text-2xl font-bold mb-5 text-dark-gray">Atur Kategori Kustom</h3>
      <div id="kategoriInputContainer" class="max-h-80 overflow-y-auto pr-2"></div>
      <button id="tambahKategoriBtn" class="bg-primary-blue hover:bg-secondary-blue text-white px-4 py-2 rounded-lg mt-5 shadow-md transition-all focus:outline-none focus:ring-2 focus:ring-primary-blue focus:ring-offset-2 flex items-center gap-2 text-sm">
        <i class="fas fa-plus-circle"></i> Tambah Kategori
      </button>
      <div class="flex justify-end gap-3 mt-7">
        <button type="button" id="tutupModalBtn" class="bg-gray-300 hover:bg-gray-400 text-dark-gray px-5 py-2 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 text-sm">Batal</button>
        <button type="button" id="simpanKategoriBtn" class="bg-accent-green hover:bg-green-700 text-white px-5 py-2 rounded-lg shadow-md transition-all flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-accent-green focus:ring-offset-2 text-sm">
          <i class="fas fa-save"></i> Simpan
        </button>
      </div>
    </div>
  </div>

  <div id="modalAturAnggaran" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-all">
    <div class="bg-card-bg p-8 rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-all">
      <h3 class="text-2xl font-bold mb-5 text-dark-gray">Atur Anggaran Bulanan</h3>
      <div id="anggaranInputContainer" class="max-h-80 overflow-y-auto pr-2"></div>
      <button type="button" id="tambahAnggaranInputBtn" class="bg-primary-blue hover:bg-secondary-blue text-white px-4 py-2 rounded-lg mt-5 shadow-md transition-all flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:ring-offset-2 text-sm">
        <i class="fas fa-plus-circle"></i> Tambah Anggaran
      </button>
      <div class="flex justify-end gap-3 mt-7">
        <button type="button" id="tutupModalAnggaranBtn" class="bg-gray-300 hover:bg-gray-400 text-dark-gray px-5 py-2 rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 text-sm">Batal</button>
        <button type="button" id="simpanAnggaranBtn" class="bg-accent-green hover:bg-green-700 text-white px-5 py-2 rounded-lg shadow-md transition-all flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-accent-green focus:ring-offset-2 text-sm">
          <i class="fas fa-save"></i> Simpan Anggaran
        </button>
      </div>
    </div>
  </div>

  <div id="modalAddTransaction" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-all">
    <div class="bg-card-bg p-8 rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-all">
      <h3 class="text-2xl font-bold mb-5 text-dark-gray">Tambah Transaksi Baru</h3>
      <form id="transactionForm">
        <div class="max-h-[60vh] overflow-y-auto pr-4 -mr-4">
          <div class="mb-4">
            <label for="transactionDate" class="block text-dark-gray text-sm font-bold mb-2">Tanggal:</label>
            <input type="date" id="transactionDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-dark-gray leading-tight focus:outline-none focus:shadow-outline" required>
          </div>
          <div class="mb-4">
            <label for="transactionType" class="block text-dark-gray text-sm font-bold mb-2">Jenis:</label>
            <select id="transactionType" class="shadow border rounded w-full py-2 px-3 text-dark-gray leading-tight focus:outline-none focus:shadow-outline" required>
              <option value="pemasukan">Pemasukan</option>
              <option value="pengeluaran">Pengeluaran</option>
              <option value="transfer">Transfer</option>
            </select>
          </div>
          <div class="mb-4" id="rekeningFromGroup">
            <label for="rekeningFrom" class="block text-dark-gray text-sm font-bold mb-2">Rekening:</label>
            <select id="rekeningFrom" class="shadow border rounded w-full py-2 px-3 text-dark-gray leading-tight focus:outline-none focus:shadow-outline" required></select>
          </div>
          <div class="mb-4 hidden" id="rekeningToGroup">
            <label for="rekeningTo" class="block text-dark-gray text-sm font-bold mb-2">Rekening Tujuan:</label>
            <select id="rekeningTo" class="shadow border rounded w-full py-2 px-3 text-dark-gray leading-tight focus:outline-none focus:shadow-outline"></select>
          </div>
          <div class="mb-4">
            <label for="transactionAccount" class="block text-dark-gray text-sm font-bold mb-2">Nama Akun/Item:</label>
            <input type="text" id="transactionAccount" placeholder="Misal: Gaji, Kopi, Belanja" class="shadow appearance-none border rounded w-full py-2 px-3 text-dark-gray leading-tight focus:outline-none focus:shadow-outline" required>
          </div>
          <div class="mb-4" id="categoryGroup">
            <label for="transactionCategory" class="block text-dark-gray text-sm font-bold mb-2">Kategori:</label>
            <select id="transactionCategory" class="shadow border rounded w-full py-2 px-3 text-dark-gray leading-tight focus:outline-none focus:shadow-outline" required></select>
          </div>
          <div class="mb-4">
            <label for="transactionNominal" class="block text-dark-gray text-sm font-bold mb-2">Nominal:</label>
            <input type="text" id="transactionNominal" placeholder="Cth: 50.000" class="shadow appearance-none border rounded w-full py-2 px-3 text-dark-gray leading-tight focus:outline-none focus:shadow-outline" required>
          </div>
          <div class="mb-4 hidden" id="transferFeeGroup">
            <label for="transferFee" class="block text-dark-gray text-sm font-bold mb-2">Biaya Admin Transfer (Opsional):</label>
            <input type="text" id="transferFee" placeholder="Cth: 2.500" class="shadow appearance-none border rounded w-full py-2 px-3 text-dark-gray leading-tight focus:outline-none focus:shadow-outline" value="0">
            <div class="mt-2 text-sm">
              <label class="inline-flex items-center mr-4">
                <input type="radio" name="feePayer" value="sender" class="form-radio text-primary-blue" checked>
                <span class="ml-2">Ditanggung Pengirim</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="feePayer" value="receiver" class="form-radio text-primary-blue">
                <span class="ml-2">Ditanggung Penerima</span>
              </label>
            </div>
          </div>
          <div class="mb-6">
            <label for="transactionDescription" class="block text-dark-gray text-sm font-bold mb-2">Deskripsi (Opsional):</label>
            <textarea id="transactionDescription" rows="2" placeholder="Detail tambahan..." class="shadow appearance-none border rounded w-full py-2 px-3 text-dark-gray leading-tight focus:outline-none focus:shadow-outline"></textarea>
          </div>
        </div>
        <div class="flex justify-end gap-3 mt-4">
          <button type="button" id="cancelTransactionBtn" class="bg-gray-300 hover:bg-gray-400 text-dark-gray px-5 py-2 rounded-lg transition-all text-sm">Batal</button>
          <button type="submit" id="saveTransactionBtn" class="bg-primary-blue hover:bg-secondary-blue text-white px-5 py-2 rounded-lg shadow-md transition-all text-sm">Simpan Transaksi</button>
        </div>
      </form>
    </div>
  </div>

<script>
  // ===================================================================================
  // SCRIPT START - KODE INI TELAH DIPERBAIKI
  // ===================================================================================
  document.addEventListener('DOMContentLoaded', () => {

  const rekeningKeys = [
    { key: 'transaksi_rekening_Cash', label: 'Cash' },
    { key: 'transaksi_rekening_BCA', label: 'BCA' },
    { key: 'transaksi_rekening_JAGO', label: 'JAGO' },
    { key: 'transaksi_rekening_DANA', label: 'DANA' },
    { key: 'transaksi_rekening_DANA_Bisnis', label: 'DANA Bisnis' },
    { key: 'transaksi_rekening_Shopeepay', label: 'Shopeepay' },
    { key: 'transaksi_rekening_Gopay', label: 'Gopay' },
    { key: 'transaksi_rekening_OVO', label: 'OVO' },
    { key: 'transaksi_rekening_Ibu', label: 'Ibu' }
  ];

  const defaultAccountCategories = [
    'Makanan & Minuman', 'Transportasi', 'Belanja', 'Pendidikan', 'Hiburan',
    'Tagihan', 'Gaji', 'Investasi', 'Kesehatan', 'Lain-lain'
  ];

  // --- PERBAIKAN UTAMA BAGIAN 2: Definisi elemen DOM di awal ---
  // Mendefinisikan elemen-elemen penting di sini agar lebih rapi dan terhindar dari bug
  const tahunEl = document.getElementById('tahun');
  const bulanEl = document.getElementById('bulan');

  let customAccountClassifications = JSON.parse(localStorage.getItem('customAccountClassifications')) || [];

  // --- PERBAIKAN UTAMA BAGIAN 1: Inisialisasi data anggaran yang lebih aman ---
  // Logika ini mencegah error jika data 'monthlyBudgets' di localStorage rusak atau
  // dalam format yang salah (misalnya array, bukan objek).
  let monthlyBudgets = {}; // Default ke objek kosong
  try {
    const storedBudgets = localStorage.getItem('monthlyBudgets');
    if (storedBudgets) { // Hanya proses jika ada data
      const parsedBudgets = JSON.parse(storedBudgets);
      // Pemeriksaan penting: pastikan data yang dimuat adalah objek dan bukan array
      if (typeof parsedBudgets === 'object' && parsedBudgets !== null && !Array.isArray(parsedBudgets)) {
        monthlyBudgets = parsedBudgets;
      } else {
        // Jika format salah, log pesan dan gunakan objek kosong untuk mencegah aplikasi error
        console.warn('Format `monthlyBudgets` di localStorage tidak valid (bukan objek), data direset.');
      }
    }
  } catch (e) {
    console.error("Gagal memuat data anggaran dari localStorage. Data direset.", e);
    // Jika JSON.parse gagal, `monthlyBudgets` akan tetap menjadi objek kosong.
  }
  // --- AKHIR PERBAIKAN UTAMA ---

  for (let y = new Date().getFullYear(); y <= new Date().getFullYear() + 10; y++) {
    tahunEl.innerHTML += `<option value="${y}">${y}</option>`;
  }
  tahunEl.value = new Date().getFullYear();
  bulanEl.value = String(new Date().getMonth() + 1).padStart(2, '0');

  const filterKategoriEl = document.getElementById('filterKategori');
  function populateFilterCategories() {
    filterKategoriEl.innerHTML = '<option value="">Semua Kategori</option>';
    const allCategories = new Set([...defaultAccountCategories]);
    customAccountClassifications.forEach(classification => allCategories.add(classification.categoryName));
    
    allCategories.add('Transfer Keluar');
    allCategories.add('Transfer Masuk');
    allCategories.add('Biaya Admin');

    Array.from(allCategories).sort().forEach(category => {
      filterKategoriEl.innerHTML += `<option value="${category}">${category}</option>`;
    });
  }
  
  const originalFormatRupiah = function(n) {
    const num = Number(n);
    if (isNaN(num)) return "Rp 0";
    const sign = num < 0 ? "-" : "";
    const absoluteNum = Math.abs(num);
    return `${sign}Rp ${absoluteNum.toLocaleString('id-ID')}`;
  };

  const parseRupiah = function(rupiahString) {
      return parseInt(String(rupiahString).replace(/\D/g, ''), 10) || 0;
  };
  
  let areNominalsVisible = false;
  
  let formatRupiahDisplay = function(n) {
      if (!areNominalsVisible) return 'Rp ********';
      return originalFormatRupiah(n);
  };

  function getSaldoSebelumBulan(label, year, month) {
    const key = `transaksi_rekening_${label.replace(/\s/g, '_')}`;
    const data = JSON.parse(localStorage.getItem(key)) || [];
    const currentMonthStartDate = new Date(year, parseInt(month) - 1, 1);
    currentMonthStartDate.setHours(0, 0, 0, 0); 
    let saldo = 0;
    data.forEach(t => {
        const transactionDate = new Date(t.tgl);
        if (transactionDate < currentMonthStartDate) {
            saldo += (t.jenis === 'pemasukan' ? t.nominal : -t.nominal);
        }
    });
    return saldo;
  }

  function getCustomCategoryForAccount(accountName) {
    for (const classification of customAccountClassifications) {
      if (classification.accounts.some(accKeyword => accountName.toLowerCase().includes(accKeyword.toLowerCase()))) {
        return classification.categoryName;
      }
    }
    return null;
  }

  function renderDashboard() {
    const bulan = bulanEl.value;
    const tahun = tahunEl.value;
    const jumlah = +document.getElementById('jumlahTransaksi').value;
    const searchNama = document.getElementById('searchNama').value.toLowerCase();
    const filterKategori = document.getElementById('filterKategori').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    const rekeningList = document.getElementById('rekeningList');
    const transaksiEl = document.getElementById('transaksiTerakhir');
    const noTransactionsMessage = document.getElementById('noTransactionsMessage');
    rekeningList.innerHTML = '';
    transaksiEl.innerHTML = '';

    let totalSaldoGlobal = 0;
    let allTransaksiForTableDisplay = []; 

    rekeningKeys.forEach(({ key, label }) => {
      const data = JSON.parse(localStorage.getItem(key)) || []; 
      let saldoAkhirRekeningIni = getSaldoSebelumBulan(label, tahun, bulan);
      const filteredForCurrentMonthTransactions = data.filter(t => t.tgl.startsWith(`${tahun}-${bulan}`));
      
      filteredForCurrentMonthTransactions.forEach(t => {
          saldoAkhirRekeningIni += (t.jenis === 'pemasukan' ? t.nominal : -t.nominal);
      });

      if (label === 'Ibu') totalSaldoGlobal -= saldoAkhirRekeningIni;
      else totalSaldoGlobal += saldoAkhirRekeningIni;

      allTransaksiForTableDisplay = allTransaksiForTableDisplay.concat(filteredForCurrentMonthTransactions.map(t => {
        const customCat = getCustomCategoryForAccount(t.akun);
        return { 
            ...t, 
            rekening: label, 
            inferredKategori: customCat || t.kategori || '-',
            deskripsi: String(t.deskripsi || '').trim() 
        };
      }));

      const el = document.createElement('div');
      el.className = 'bg-card-bg rounded-xl shadow-md p-4 transition-all card-hover cursor-pointer border-l-4 border-primary-blue';
      el.onclick = () => window.location.href = `rekening-${label.toLowerCase().replace(/\s/g, '')}.html`;
      el.innerHTML = `<h3 class="font-bold text-dark-gray text-lg mb-1">${label}</h3><p class="text-accent-green font-extrabold text-2xl" data-rekening-saldo="${label}">${formatRupiahDisplay(saldoAkhirRekeningIni)}</p>`;
      rekeningList.appendChild(el);
    });

    document.getElementById('displayTotalKekayaan').textContent = formatRupiahDisplay(totalSaldoGlobal);
    renderCustomCategorySummary(bulan, tahun);
    renderBudgetSummary(bulan, tahun);
    renderBalanceChart();

    let filteredTransactionsForTable = allTransaksiForTableDisplay.filter(t => {
      const matchNama = t.akun.toLowerCase().includes(searchNama);
      let matchKategori = filterKategori === '' || (t.inferredKategori && t.inferredKategori.toLowerCase() === filterKategori.toLowerCase());
      const tgl = new Date(t.tgl);
      const from = startDate ? new Date(startDate) : null; 
      const to = endDate ? new Date(endDate) : null; 
      if (from) from.setHours(0, 0, 0, 0);
      if (to) to.setHours(23, 59, 59, 999);
      const matchTanggal = (!from || tgl >= from) && (!to || tgl <= to);
      return matchNama && matchKategori && matchTanggal;
    });

    filteredTransactionsForTable.sort((a, b) => new Date(b.tgl + 'T' + (b.timestamp || '00:00:00')) - new Date(a.tgl + 'T' + (a.timestamp || '00:00:00')));

    if (filteredTransactionsForTable.length > 0) {
      transaksiEl.innerHTML = filteredTransactionsForTable.slice(0, jumlah).map(t => {
        const nominalClass = t.jenis === 'pemasukan' ? 'text-accent-green' : 'text-accent-red';
        const jenisText = t.jenis.charAt(0).toUpperCase() + t.jenis.slice(1);
        return `
          <tr class="hover:bg-gray-50 transition duration-150 ease-in-out">
            <td class="p-3">${t.tgl}</td>
            <td class="p-3 font-medium">${t.rekening}</td>
            <td class="p-3">${t.akun}</td>
            <td class="p-3">${t.inferredKategori}</td>
            <td class="p-3 text-right font-semibold ${nominalClass}" data-nominal-transaksi>${formatRupiahDisplay(t.nominal)}</td>
            <td class="p-3">${jenisText}</td>
          </tr>
        `;
      }).join('');
      noTransactionsMessage.classList.add('hidden');
    } else {
      transaksiEl.innerHTML = '';
      noTransactionsMessage.classList.remove('hidden');
    }

    const toggleButton = document.querySelector('.toggle-visibility-btn');
    if (toggleButton) toggleButton.innerHTML = areNominalsVisible ? '&#128065;' : '&#128064;';
  }

  function toggleAllNominalVisibility() {
      areNominalsVisible = !areNominalsVisible;
      renderDashboard(); // Cukup panggil renderDashboard untuk update seluruh UI
  }

  document.querySelector('.toggle-visibility-btn[data-target="all-nominal"]').addEventListener('click', toggleAllNominalVisibility);

  const balanceChartCanvas = document.getElementById('balanceChart');
  let balanceChartInstance = null;

  function renderBalanceChart() {
    const selectedYear = tahunEl.value;
    const monthlyBalances = getMonthlyBalancesForYear(selectedYear);
    const labels = Object.keys(monthlyBalances);
    const data = Object.values(monthlyBalances);
    if (balanceChartInstance) balanceChartInstance.destroy();
    balanceChartInstance = new Chart(balanceChartCanvas, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: `Saldo Akhir ${selectedYear}`, data: data, borderColor: '#1a237e',
          backgroundColor: 'rgba(26, 35, 126, 0.2)', fill: true, tension: 0.3,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 10 } } },
          y: { beginAtZero: false, ticks: { callback: value => originalFormatRupiah(value).replace('Rp ', '') } }
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: context => `${context.dataset.label}: ${originalFormatRupiah(context.raw)}` } }
        }
      }
    });
  }
  
  function getMonthlyBalancesForYear(year) {
      const monthlyBalances = {};
      const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
      let totalSaldoAkhirTahunLalu = 0;
      rekeningKeys.forEach(({ key, label }) => {
          const data = JSON.parse(localStorage.getItem(key)) || [];
          const lastYearTransactions = data.filter(t => new Date(t.tgl).getFullYear() < year);
          let saldoTahunLalu = 0;
          lastYearTransactions.forEach(t => saldoTahunLalu += (t.jenis === 'pemasukan' ? t.nominal : -t.nominal));
          if (label === 'Ibu') totalSaldoAkhirTahunLalu -= saldoTahunLalu;
          else totalSaldoAkhirTahunLalu += saldoTahunLalu;
      });

      let runningTotal = totalSaldoAkhirTahunLalu;
      for (let i = 0; i < 12; i++) {
          const month = String(i + 1).padStart(2, '0');
          let netChangeForThisMonth = 0;
          rekeningKeys.forEach(({ key, label }) => {
              const data = JSON.parse(localStorage.getItem(key)) || [];
              const transactionsForMonth = data.filter(t => t.tgl.startsWith(`${year}-${month}`));
              let monthlyChangeForRekening = 0;
              transactionsForMonth.forEach(t => monthlyChangeForRekening += (t.jenis === 'pemasukan' ? t.nominal : -t.nominal));
              if (label === 'Ibu') netChangeForThisMonth -= monthlyChangeForRekening;
              else netChangeForThisMonth += monthlyChangeForRekening;
          });
          runningTotal += netChangeForThisMonth;
          monthlyBalances[months[i]] = runningTotal;
      }
      return monthlyBalances;
  }

  // --- Custom Category Logic ---
  const modalAturKategori = document.getElementById('modalAturKategori');
  const aturKategoriBtn = document.getElementById('aturKategoriBtn');
  const tutupModalBtn = document.getElementById('tutupModalBtn');
  const tambahKategoriBtn = document.getElementById('tambahKategoriBtn');
  const simpanKategoriBtn = document.getElementById('simpanKategoriBtn');
  const kategoriInputContainer = document.getElementById('kategoriInputContainer');
  const ringkasanKategoriKustomEl = document.getElementById('ringkasanKategoriKustom');

  aturKategoriBtn.addEventListener('click', () => {
    renderKategoriInputs();
    modalAturKategori.classList.remove('hidden', 'opacity-0', 'scale-95');
    setTimeout(() => modalAturKategori.classList.add('opacity-100', 'scale-100'), 10);
  });

  tutupModalBtn.addEventListener('click', () => {
    modalAturKategori.classList.remove('opacity-100', 'scale-100');
    setTimeout(() => modalAturKategori.classList.add('hidden'), 300);
  });

  tambahKategoriBtn.addEventListener('click', () => {
    addKategoriInput();
    kategoriInputContainer.scrollTop = kategoriInputContainer.scrollHeight;
  });

  simpanKategoriBtn.addEventListener('click', () => {
    saveKategoriSettings();
    modalAturKategori.classList.remove('opacity-100', 'scale-100');
    setTimeout(() => modalAturKategori.classList.add('hidden'), 300);
    populateFilterCategories(); 
    populateTransactionCategories();
    renderDashboard(); 
    showToast("Pengaturan kategori berhasil disimpan!", "success");
  });

  function renderKategoriInputs() {
    kategoriInputContainer.innerHTML = '';
    if (customAccountClassifications.length === 0) {
      addKategoriInput(); 
      return;
    }
    customAccountClassifications.forEach((classification, index) => {
      addKategoriInput(classification.categoryName, classification.accounts.join(', '), index);
    });
  }

  function addKategoriInput(categoryName = '', accounts = '', index = null) {
    const div = document.createElement('div');
    div.className = 'border border-gray-200 p-4 rounded-lg mb-4 bg-gray-50';
    const uniqueId = index !== null ? `existing-${index}` : `new-${Date.now()}`;
    div.innerHTML = `
      <div class="flex justify-between items-center mb-3">
        <label for="categoryName-${uniqueId}" class="font-medium text-dark-gray">Nama Kategori:</label>
        <button type="button" class="hapus-kategori-btn text-accent-red hover:text-red-700 font-bold text-lg leading-none focus:outline-none">&times;</button>
      </div>
      <input type="text" id="categoryName-${uniqueId}" placeholder="Nama Kategori (misal: Pendapatan)" value="${categoryName}"
             class="w-full border border-gray-300 px-3 py-2 rounded-md shadow-sm mb-3 focus:ring-primary-blue focus:border-primary-blue category-name-input">
      <label for="accounts-${uniqueId}" class="font-medium text-dark-gray">Akun (pisahkan dengan koma):</label>
      <input type="text" id="accounts-${uniqueId}" placeholder="Contoh: Gaji, Ceperan, Bonus" value="${accounts}"
             class="w-full border border-gray-300 px-3 py-2 rounded-md shadow-sm focus:ring-primary-blue focus:border-primary-blue accounts-input">
    `;
    kategoriInputContainer.appendChild(div);
    div.querySelector('.hapus-kategori-btn').addEventListener('click', () => div.remove());
  }

  function saveKategoriSettings() {
    const newClassifications = [];
    kategoriInputContainer.querySelectorAll('.border').forEach(div => {
      const categoryName = div.querySelector('.category-name-input').value.trim();
      const accounts = div.querySelector('.accounts-input').value.split(',').map(acc => acc.trim()).filter(acc => acc);
      if (categoryName && accounts.length > 0) {
        newClassifications.push({ categoryName, accounts });
      }
    });
    customAccountClassifications = newClassifications;
    localStorage.setItem('customAccountClassifications', JSON.stringify(customAccountClassifications));
  }

  function renderCustomCategorySummary(currentMonth, currentYear) {
    ringkasanKategoriKustomEl.innerHTML = '';
    if (customAccountClassifications.length === 0) {
      ringkasanKategoriKustomEl.innerHTML = '<p class="text-gray-500 text-center col-span-full">Belum ada kategori kustom.</p>';
      return;
    }
    customAccountClassifications.forEach(classification => {
      let totalNominalForCategory = 0;
      rekeningKeys.forEach(({ key }) => {
        const data = JSON.parse(localStorage.getItem(key)) || [];
        const transactions = data.filter(t => t.tgl.startsWith(`${currentYear}-${currentMonth}`) && classification.accounts.some(keyword => t.akun.toLowerCase().includes(keyword.toLowerCase())));
        transactions.forEach(t => totalNominalForCategory += t.nominal);
      });
      const div = document.createElement('div');
      div.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
      div.innerHTML = `
        <h4 class="font-semibold text-primary-blue text-lg mb-1">${classification.categoryName}</h4>
        <p class="text-2xl font-bold text-dark-gray">${formatRupiahDisplay(totalNominalForCategory)}</p>`;
      ringkasanKategoriKustomEl.appendChild(div);
    });
  }

  // --- Budgeting Logic ---
  const modalAturAnggaran = document.getElementById('modalAturAnggaran');
  const aturAnggaranBtn = document.getElementById('aturAnggaranBtn');
  const tutupModalAnggaranBtn = document.getElementById('tutupModalAnggaranBtn');
  const tambahAnggaranInputBtn = document.getElementById('tambahAnggaranInputBtn');
  const simpanAnggaranBtn = document.getElementById('simpanAnggaranBtn');
  const anggaranInputContainer = document.getElementById('anggaranInputContainer');
  const anggaranSummaryEl = document.getElementById('anggaranSummary');

  aturAnggaranBtn.addEventListener('click', () => {
    const currentMonthYear = `${tahunEl.value}-${bulanEl.value}`;
    renderAnggaranInputs(currentMonthYear);
    modalAturAnggaran.classList.remove('hidden', 'opacity-0');
    setTimeout(() => modalAturAnggaran.classList.add('opacity-100', 'scale-100'), 10);
  });

  tutupModalAnggaranBtn.addEventListener('click', () => {
    modalAturAnggaran.classList.remove('opacity-100', 'scale-100');
    setTimeout(() => modalAturAnggaran.classList.add('hidden'), 300);
  });

  tambahAnggaranInputBtn.addEventListener('click', () => {
    addAnggaranInput();
    anggaranInputContainer.scrollTop = anggaranInputContainer.scrollHeight;
  });

  simpanAnggaranBtn.addEventListener('click', () => {
    saveAnggaranSettings();
    modalAturAnggaran.classList.remove('opacity-100', 'scale-100');
    setTimeout(() => modalAturAnggaran.classList.add('hidden'), 300);
    renderDashboard();
    showToast("Pengaturan anggaran berhasil disimpan!", "success");
  });

  function renderAnggaranInputs(currentMonthYear) {
    anggaranInputContainer.innerHTML = '';
    const currentMonthBudget = monthlyBudgets[currentMonthYear] || [];
    if (currentMonthBudget.length === 0) {
      addAnggaranInput(); 
      return;
    }
    currentMonthBudget.forEach(budget => addAnggaranInput(budget.category, budget.amount));
  }

  function addAnggaranInput(category = '', amount = '') {
    const div = document.createElement('div');
    div.className = 'border border-gray-200 p-4 rounded-lg mb-4 bg-gray-50 anggaran-item';
    const uniqueId = Date.now();
    const allCategoriesSet = new Set([...defaultAccountCategories, ...customAccountClassifications.map(c => c.categoryName)]);
    const categoriesForBudgeting = Array.from(allCategoriesSet).filter(cat => !['Transfer Keluar', 'Transfer Masuk', 'Biaya Admin', 'Gaji'].includes(cat));
    const categoryOptions = categoriesForBudgeting.sort().map(cat => `<option value="${cat}" ${cat === category ? 'selected' : ''}>${cat}</option>`).join('');

    div.innerHTML = `
      <div class="flex justify-between items-center mb-3">
        <label for="budgetCategory-${uniqueId}" class="font-medium text-dark-gray">Kategori:</label>
        <button type="button" class="hapus-anggaran-btn text-accent-red hover:text-red-700 font-bold text-lg leading-none focus:outline-none">&times;</button>
      </div>
      <select id="budgetCategory-${uniqueId}" class="w-full border border-gray-300 px-3 py-2 rounded-md shadow-sm mb-3 focus:ring-primary-blue focus:border-primary-blue budget-category-select">
        <option value="">Pilih Kategori</option>${categoryOptions}
      </select>
      <label for="budgetAmount-${uniqueId}" class="font-medium text-dark-gray">Nominal Anggaran:</label>
      <input type="text" id="budgetAmount-${uniqueId}" placeholder="Contoh: 1.000.000" value="${amount ? originalFormatRupiah(amount).replace('Rp ', '') : ''}"
             class="w-full border border-gray-300 px-3 py-2 rounded-md shadow-sm focus:ring-primary-blue focus:border-primary-blue budget-amount-input">`;
    anggaranInputContainer.appendChild(div);

    const budgetAmountInput = div.querySelector('.budget-amount-input');
    budgetAmountInput.addEventListener('input', () => {
        let value = budgetAmountInput.value.replace(/\D/g, '');
        budgetAmountInput.value = value ? parseInt(value, 10).toLocaleString('id-ID') : '';
    });
    div.querySelector('.hapus-anggaran-btn').addEventListener('click', () => div.remove());
  }

  function saveAnggaranSettings() {
    const currentMonthYear = `${tahunEl.value}-${bulanEl.value}`;
    const newMonthBudgets = [];
    document.querySelectorAll('.anggaran-item').forEach(item => {
      const category = item.querySelector('.budget-category-select').value;
      const amount = parseRupiah(item.querySelector('.budget-amount-input').value);
      if (category && amount > 0) newMonthBudgets.push({ category, amount });
    });
    monthlyBudgets[currentMonthYear] = newMonthBudgets;
    localStorage.setItem('monthlyBudgets', JSON.stringify(monthlyBudgets));
  }

  function renderBudgetSummary(currentMonth, currentYear) {
    anggaranSummaryEl.innerHTML = '';
    const currentMonthYear = `${currentYear}-${currentMonth}`;
    const budgetsForThisMonth = monthlyBudgets[currentMonthYear] || [];

    if (budgetsForThisMonth.length === 0) {
      anggaranSummaryEl.innerHTML = '<p class="text-gray-500 text-center col-span-full">Belum ada anggaran untuk bulan ini.</p>';
      return;
    }

    const categoryActualSpending = {};
    rekeningKeys.forEach(({ key }) => {
      const data = JSON.parse(localStorage.getItem(key)) || [];
      const transactions = data.filter(t => t.tgl.startsWith(currentMonthYear) && t.jenis === 'pengeluaran');
      transactions.forEach(t => {
        const inferredCat = getCustomCategoryForAccount(t.akun) || t.kategori || 'Lain-lain';
        if (inferredCat !== 'Transfer Keluar' && inferredCat !== 'Biaya Admin') {
            categoryActualSpending[inferredCat] = (categoryActualSpending[inferredCat] || 0) + t.nominal;
        }
      });
    });

    budgetsForThisMonth.forEach(budget => {
      const { category, amount: budgetedAmount } = budget;
      const actualSpending = categoryActualSpending[category] || 0;
      const remaining = budgetedAmount - actualSpending;
      const percentageUsed = budgetedAmount > 0 ? (actualSpending / budgetedAmount) * 100 : 0;
      const progressBarColor = percentageUsed >= 90 ? 'bg-accent-red' : percentageUsed >= 70 ? 'bg-yellow-500' : 'bg-accent-green';
      const div = document.createElement('div');
      div.className = 'bg-white p-4 rounded-lg shadow-sm border-l-4 border-gray-200';
      div.innerHTML = `
        <h4 class="font-semibold text-dark-gray text-lg mb-1">${category}</h4>
        <p class="text-sm text-gray-600 mb-2">Anggaran: ${originalFormatRupiah(budgetedAmount)}</p>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
          <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${Math.min(100, percentageUsed)}%"></div>
        </div>
        <p class="text-sm text-gray-600 mb-1">Terpakai: <span class="font-bold text-xl">${formatRupiahDisplay(actualSpending)}</span></p>
        <p class="text-sm text-gray-600">Sisa: <span class="font-bold text-xl ${remaining >= 0 ? 'text-accent-green' : 'text-accent-red'}">${formatRupiahDisplay(remaining)}</span></p>`;
      anggaranSummaryEl.appendChild(div);
    });
  }

  // --- Add Transaction / Transfer Modal Logic ---
  const addTransactionBtn = document.getElementById('addTransactionBtn');
  const modalAddTransaction = document.getElementById('modalAddTransaction');
  const cancelTransactionBtn = document.getElementById('cancelTransactionBtn');
  const transactionForm = document.getElementById('transactionForm');
  const transactionTypeSelect = document.getElementById('transactionType');
  const rekeningFromSelect = document.getElementById('rekeningFrom');
  const rekeningToSelect = document.getElementById('rekeningTo');
  const rekeningFromGroup = document.getElementById('rekeningFromGroup');
  const rekeningToGroup = document.getElementById('rekeningToGroup');
  const transactionCategorySelect = document.getElementById('transactionCategory');
  const categoryGroup = document.getElementById('categoryGroup');
  const transactionAccountInput = document.getElementById('transactionAccount');
  const transactionNominalInput = document.getElementById('transactionNominal');
  const transactionDescriptionInput = document.getElementById('transactionDescription');
  const transferFeeGroup = document.getElementById('transferFeeGroup'); 
  const transferFeeInput = document.getElementById('transferFee');

  function populateRekeningSelects() {
    rekeningFromSelect.innerHTML = '';
    rekeningToSelect.innerHTML = ''; 
    rekeningKeys.forEach(({ label }) => {
      rekeningFromSelect.innerHTML += `<option value="${label}">${label}</option>`;
      rekeningToSelect.innerHTML += `<option value="${label}">${label}</option>`;
    });
  }

  function populateTransactionCategories() {
      transactionCategorySelect.innerHTML = '';
      const allCategories = new Set([...defaultAccountCategories, ...customAccountClassifications.map(c => c.categoryName)]);
      const regularCategories = Array.from(allCategories).filter(cat => !['Transfer Keluar', 'Transfer Masuk', 'Biaya Admin'].includes(cat));
      regularCategories.sort().forEach(category => transactionCategorySelect.innerHTML += `<option value="${category}">${category}</option>`);
  }
  
  const formatInputAsRupiah = (inputEl) => {
    let value = inputEl.value.replace(/\D/g, ''); 
    inputEl.value = value ? parseInt(value, 10).toLocaleString('id-ID') : '';
  };
  transactionNominalInput.addEventListener('input', () => formatInputAsRupiah(transactionNominalInput));
  transferFeeInput.addEventListener('input', () => formatInputAsRupiah(transferFeeInput));

  addTransactionBtn.addEventListener('click', () => {
    populateRekeningSelects();
    populateTransactionCategories(); 
    document.getElementById('transactionDate').valueAsDate = new Date();
    transactionForm.reset();
    transactionTypeSelect.value = 'pengeluaran'; 
    transferFeeInput.value = '0';
    document.querySelector('input[name="feePayer"][value="sender"]').checked = true;
    updateTransactionFormVisibility(); 
    modalAddTransaction.classList.remove('hidden', 'opacity-0');
    setTimeout(() => modalAddTransaction.classList.add('opacity-100', 'scale-100'), 10);
  });

  cancelTransactionBtn.addEventListener('click', () => {
    modalAddTransaction.classList.remove('opacity-100', 'scale-100');
    setTimeout(() => modalAddTransaction.classList.add('hidden'), 300);
  });

  transactionTypeSelect.addEventListener('change', updateTransactionFormVisibility);

  function updateTransactionFormVisibility() {
    const type = transactionTypeSelect.value;
    const isTransfer = type === 'transfer';
    rekeningFromGroup.querySelector('label').textContent = isTransfer ? 'Rekening Asal:' : 'Rekening:';
    rekeningToGroup.classList.toggle('hidden', !isTransfer);
    transferFeeGroup.classList.toggle('hidden', !isTransfer);
    categoryGroup.classList.toggle('hidden', isTransfer);
    transactionCategorySelect.required = !isTransfer;
    transactionAccountInput.placeholder = isTransfer ? 'Deskripsi Transfer (Opsional)' : 'Misal: Gaji, Kopi, Belanja';
    transactionAccountInput.required = !isTransfer;
    if (isTransfer) transactionAccountInput.value = '';
  }

  transactionForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const date = document.getElementById('transactionDate').value;
    const type = transactionTypeSelect.value;
    const nominal = parseRupiah(transactionNominalInput.value); 
    const description = transactionDescriptionInput.value.trim();
    const transferFee = parseRupiah(transferFeeInput.value); 
    const feePayer = document.querySelector('input[name="feePayer"]:checked')?.value; 

    if (isNaN(nominal) || nominal <= 0) return showToast("Nominal harus angka positif.", "error");
    if (isNaN(transferFee) || transferFee < 0) return showToast("Biaya admin tidak valid.", "error");

    const newTransaction = {
      tgl: date,
      deskripsi: description,
      timestamp: new Date().toLocaleTimeString('id-ID', { hour12: false })
    };

    if (type === 'transfer') {
      const rekeningFromLabel = rekeningFromSelect.value;
      const rekeningToLabel = rekeningToSelect.value;
      if (rekeningFromLabel === rekeningToLabel) return showToast("Rekening asal dan tujuan tidak boleh sama.", "error");
      
      const rekeningFromKey = `transaksi_rekening_${rekeningFromLabel.replace(/\s/g, '_')}`;
      const rekeningToKey = `transaksi_rekening_${rekeningToLabel.replace(/\s/g, '_')}`;
      let dataFrom = JSON.parse(localStorage.getItem(rekeningFromKey)) || [];
      let dataTo = JSON.parse(localStorage.getItem(rekeningToKey)) || [];

      dataFrom.push({ ...newTransaction, akun: `Transfer ke ${rekeningToLabel}`, kategori: 'Transfer Keluar', nominal: nominal, jenis: 'pengeluaran' });
      
      let actualNominalReceived = nominal - (transferFee > 0 && feePayer === 'receiver' ? transferFee : 0);
      if(actualNominalReceived < 0) return showToast("Nominal transfer kurang dari biaya admin.", "error");

      dataTo.push({ ...newTransaction, akun: `Transfer dari ${rekeningFromLabel}`, kategori: 'Transfer Masuk', nominal: actualNominalReceived, jenis: 'pemasukan' });

      if (transferFee > 0) {
        if (feePayer === 'sender') {
          dataFrom.push({ ...newTransaction, akun: `Biaya Admin Transfer`, kategori: 'Biaya Admin', nominal: transferFee, jenis: 'pengeluaran' });
        } else { // receiver
          dataTo.push({ ...newTransaction, akun: `Biaya Admin Transfer`, kategori: 'Biaya Admin', nominal: transferFee, jenis: 'pengeluaran' });
        }
      }
      localStorage.setItem(rekeningFromKey, JSON.stringify(dataFrom));
      localStorage.setItem(rekeningToKey, JSON.stringify(dataTo));
      showToast(`Transfer sebesar ${originalFormatRupiah(nominal)} berhasil!`, "success");
    } else {
      const rekeningKey = `transaksi_rekening_${rekeningFromSelect.value.replace(/\s/g, '_')}`;
      const accountName = transactionAccountInput.value.trim();
      const category = transactionCategorySelect.value;
      if (!accountName || !category) return showToast("Nama akun dan kategori harus diisi.", "error");
      let data = JSON.parse(localStorage.getItem(rekeningKey)) || [];
      data.push({ ...newTransaction, akun: accountName, kategori: category, nominal: nominal, jenis: type });
      localStorage.setItem(rekeningKey, JSON.stringify(data));
      showToast("Transaksi berhasil ditambahkan!", "success");
    }
    cancelTransactionBtn.click();
    renderDashboard();
  });

  // --- Export/Import & Reset Functions ---
  const downloadData = (format) => {
    const { jsPDF } = window.jspdf;
    const bulan = bulanEl.value;
    const tahun = tahunEl.value;
    let allData = [];
    rekeningKeys.forEach(({ key, label }) => {
      const data = JSON.parse(localStorage.getItem(key)) || [];
      const filtered = data.filter(t => t.tgl.startsWith(`${tahun}-${bulan}`));
      filtered.forEach(d => {
        const customCat = getCustomCategoryForAccount(d.akun);
        allData.push({ Tanggal: d.tgl, Rekening: label, Akun: d.akun, Kategori: customCat || d.kategori || '-', Keterangan: d.deskripsi || '', Nominal: d.nominal, Jenis: d.jenis });
      });
    });

    if (allData.length === 0) return showToast("Tidak ada data untuk diekspor!", "warning");

    const fileName = `Transaksi-${tahun}-${bulan}-${new Date().getDate()}`;
    if (format === 'excel') {
      const ws = XLSX.utils.json_to_sheet(allData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Transaksi");
      XLSX.writeFile(wb, `${fileName}.xlsx`);
      showToast("Ekspor ke Excel berhasil!", "success");
    } else { // pdf
      const doc = new jsPDF();
      const rows = allData.map(d => [d.Tanggal, d.Rekening, d.Akun, d.Kategori, d.Keterangan, originalFormatRupiah(d.Nominal), d.Jenis]);
      doc.text(`Laporan Transaksi Keuangan - ${bulan}/${tahun}`, 14, 15);
      doc.autoTable({
        startY: 25, head: [['Tanggal', 'Rekening', 'Akun', 'Kategori', 'Keterangan', 'Nominal', 'Jenis']], body: rows,
        theme: 'grid', headStyles: { fillColor: [26, 35, 126] }, styles: { fontSize: 8 }, columnStyles: { 5: { halign: 'right' } }
      });
      doc.save(`${fileName}.pdf`);
      showToast("Ekspor ke PDF berhasil!", "success");
    }
  };
  document.getElementById('downloadExcel').addEventListener('click', () => downloadData('excel'));
  document.getElementById('downloadPDF').addEventListener('click', () => downloadData('pdf'));
  
  document.getElementById('downloadLaporanBulanan').addEventListener('click', function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const bulan = bulanEl.value;
    const namaBulan = new Date(2000, parseInt(bulan) - 1, 1).toLocaleString('id-ID', { month: 'long' });
    const tahun = tahunEl.value;
    let totalPemasukan = 0, totalPengeluaran = 0;
    const rekeningSaldoAwal = {}, rekeningSaldoAkhir = {};
    let allTransactionsInMonth = [];

    rekeningKeys.forEach(({ key, label }) => {
        rekeningSaldoAwal[label] = getSaldoSebelumBulan(label, tahun, bulan); 
        const data = JSON.parse(localStorage.getItem(key)) || [];
        allTransactionsInMonth.push(...data.filter(t => t.tgl.startsWith(`${tahun}-${bulan}`)).map(t => ({ ...t, rekening: label })));
    });

    allTransactionsInMonth.forEach(t => {
        const category = getCustomCategoryForAccount(t.akun) || t.kategori;
        if (t.jenis === 'pemasukan' && category !== 'Transfer Masuk') totalPemasukan += t.nominal;
        else if (t.jenis === 'pengeluaran' && category !== 'Transfer Keluar') totalPengeluaran += t.nominal;
    });

    rekeningKeys.forEach(({ label }) => {
        let netChange = 0;
        allTransactionsInMonth.filter(t => t.rekening === label).forEach(t => netChange += (t.jenis === 'pemasukan' ? t.nominal : -t.nominal));
        rekeningSaldoAkhir[label] = rekeningSaldoAwal[label] + netChange;
    });

    let totalWealth = Object.entries(rekeningSaldoAkhir).reduce((sum, [label, saldo]) => sum + (label === 'Ibu' ? -saldo : saldo), 0);
    
    doc.setFontSize(16); doc.text(`Laporan Keuangan Bulanan`, 14, 15);
    doc.setFontSize(12); doc.text(`Periode: ${namaBulan} ${tahun}`, 14, 22);
    
    const summaryData = [
      ['Total Pemasukan', originalFormatRupiah(totalPemasukan)],
      ['Total Pengeluaran', originalFormatRupiah(totalPengeluaran)],
      ['Net Profit/Loss', originalFormatRupiah(totalPemasukan - totalPengeluaran)],
      ['Total Kekayaan Akhir', originalFormatRupiah(totalWealth)]
    ];
    doc.autoTable({ startY: 30, head: [['Deskripsi', 'Nominal']], body: summaryData, theme: 'grid' });

    const rekeningRows = rekeningKeys.map(({ label }) => [label, originalFormatRupiah(rekeningSaldoAwal[label]), originalFormatRupiah(rekeningSaldoAkhir[label])]);
    doc.autoTable({ startY: doc.autoTable.previous.finalY + 10, head: [['Rekening', 'Saldo Awal', 'Saldo Akhir']], body: rekeningRows, theme: 'grid' });

    doc.save(`Laporan-Keuangan-${namaBulan}-${tahun}.pdf`);
    showToast("Laporan bulanan berhasil diunduh!", "success");
  });

  document.getElementById('exportBackup').addEventListener('click', function () {
    const allData = {};
    Object.keys(localStorage).forEach(key => allData[key] = localStorage.getItem(key));
    const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Backup-Keuangan-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    showToast("Data berhasil diekspor!", "success");
  });

  document.getElementById("resetData").addEventListener("click", function () {
    if (confirm("Yakin ingin MENGHAPUS SELURUH data? Tindakan ini tidak bisa dibatalkan. Pastikan sudah backup!")) {
      localStorage.clear();
      showToast("Data berhasil direset! Halaman akan dimuat ulang.", "warning");
      setTimeout(() => location.reload(), 1500);
    }
  });

  document.getElementById('importBackup').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        const data = JSON.parse(evt.target.result);
        localStorage.clear();
        Object.entries(data).forEach(([key, value]) => localStorage.setItem(key, value));
        showToast("Data berhasil diimpor! Halaman akan dimuat ulang.", "success");
        setTimeout(() => location.reload(), 1500);
      } catch {
        showToast("Gagal import data! Pastikan file JSON valid.", "error");
      }
    };
    reader.readAsText(file);
  });
  
  ['jumlahTransaksi', 'bulan', 'tahun', 'filterKategori', 'startDate', 'endDate'].forEach(id => document.getElementById(id).addEventListener('change', renderDashboard));
  document.getElementById('searchNama').addEventListener('input', renderDashboard);

  function showToast(pesan, type = 'success') {
    const styles = {
      success: { bg: 'bg-accent-green', icon: 'fa-check-circle' },
      error: { bg: 'bg-accent-red', icon: 'fa-times-circle' },
      warning: { bg: 'bg-orange-500', icon: 'fa-exclamation-triangle' },
      info: { bg: 'bg-primary-blue', icon: 'fa-info-circle' }
    };
    const style = styles[type];
    const div = document.createElement('div');
    div.className = `${style.bg} text-white px-5 py-3 rounded-xl shadow-lg flex items-center gap-3 animate-slide-in-fade transition-all duration-500`;
    div.innerHTML = `<span><i class="fas ${style.icon}"></i></span><span class="font-medium">${pesan}</span>`;
    document.getElementById('toastContainer').appendChild(div);
    setTimeout(() => {
      div.style.opacity = '0';
      div.style.transform = 'translateX(100%)';
      setTimeout(() => div.remove(), 500);
    }, 3500);
  }
  
  // Initial render
  populateFilterCategories();
  renderDashboard();

});
</script>
</body>
</html>
